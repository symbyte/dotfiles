# General
alias "emacs"='emacsclient -nw -a ""'
alias "vim"="nvim"
alias "c"="claude --dangerously-skip-permissions"

mkcd() {
	mkdir $1 && cd $1
}

# Git
alias "glog"="git lg3"
alias "gs"="git status"
alias "gc"="git commit"
alias "gf"="git fetch --prune"
alias "gfm"="git fetch origin master --prune"
alias "gpl"="git pull --rebase"
alias "gp"="git push"
alias "gpu"="git push -u origin HEAD"
alias "gam"="git commit --amend --no-edit"
alias "gama"="git commit -a --amend --no-edit"
alias "gch"="git checkout"
alias "gr"="git rebase"
alias "grm"="git rebase origin/master"
alias "gd"="git diff"
alias "gdc"="git diff --cached"
alias "gpf"="git push --force-with-lease"
alias "grc"="git rebase --continue"
alias "gcb"="git branch --merged | egrep -v \"(^\*|master|develop|test)\" | xargs git branch -d"
alias "lg"="lazygit"
alias "pr"="nvim -c 'Octo pr'"
alias "dfadd"="~/dotfiles/bin/add"
alias "db"="lazysql"

if [ -n "$NVIM_LISTEN_ADDRESS" ]; then
    alias nvim=nvr -cc split --remote-wait +'set bufhidden=wipe'
fi

findandkill() {
  port=$(lsof -n -i4TCP:$1 | grep LISTEN | awk '{ print $2 }')
  kill -9 $port
}
alias killport=findandkill

wip() {
	git commit -a -m "WIP: $1"
}

# Tmux
alias "tks"="tmux kill-session"
alias "tl"="tmuxp load "
alias "ta"="tmux a"

alias ls="eza --icons=auto"

# Remove nvim swap files containing "octo"
alias clean-octo-swaps="find ~/.local/state/nvim/swap -name '*octo*' -type f -delete"

# allprs is now a script in ~/.local/bin/allprs (uses Zellij instead of WezTerm)

# Create worktree from branch with fzf selection
wt() {
  local repo_dir="$HOME/projects/apricot"
  local wt_base="$HOME/projects/wt"

  # Fetch latest branches
  (builtin cd "$repo_dir" && git fetch --prune --quiet)

  # Select branch with fzf, staging as default
  local branch
  branch=$(
    builtin cd "$repo_dir" && git branch -r --format='%(refname:short)' \
    | sed 's|^origin/||' \
    | awk '!seen[$0]++' \
    | fzf --query="staging" --select-1 --header="Select base branch"
  )

  [[ -z "$branch" ]] && return

  # Prompt for worktree name
  local wt_name
  echo -n "Worktree name: "
  read wt_name

  [[ -z "$wt_name" ]] && echo "Cancelled" && return

  local wt_path="$wt_base/$wt_name"

  # Create worktree
  (builtin cd "$repo_dir" && git worktree add "$wt_path" "origin/$branch")

  [[ $? -ne 0 ]] && return 1

  cd "$wt_path" && $EDITOR .
}

# Query Linear issue status (returns: completed, canceled, started, unstarted, backlog, triage)
_linear_issue_status() {
  local issue_id="$1"
  local response
  response=$(curl -s -X POST https://api.linear.app/graphql \
    -H "Content-Type: application/json" \
    -H "Authorization: ${LINEAR_API_KEY}" \
    -d "{\"query\": \"{ issue(id: \\\"${issue_id}\\\") { state { type } } }\"}")
  echo "$response" | jq -r '.data.issue.state.type // "unknown"'
}

# Remove worktrees with fzf multi-select (closed Linear issues pre-selected)
wtd() {
  local repo_dir="$HOME/projects/apricot"
  local wt_base="$HOME/projects/wt"

  echo "Checking Linear issue statuses..."

  # Build list: closed issues first (will be pre-selected)
  local -a closed_items open_items
  local wt_name issue_state
  for wt_name in $(command ls -1 "$wt_base" 2>/dev/null); do
    if [[ "$wt_name" =~ ^[a-z]{3,}-[0-9]+$ ]] && [[ ! "$wt_name" =~ ^pr- ]]; then
      issue_state=$(_linear_issue_status "$wt_name")
      if [[ "$issue_state" == "completed" || "$issue_state" == "canceled" ]]; then
        closed_items+=("● $wt_name")
      else
        open_items+=("  $wt_name")
      fi
    else
      open_items+=("  $wt_name")
    fi
  done

  local total_closed=${#closed_items[@]}

  local -a selected
  selected=("${(@f)$(
    { printf '%s\n' "${closed_items[@]}"; printf '%s\n' "${open_items[@]}"; } \
    | fzf --multi \
          --header="● = closed issue (${total_closed} found). All pre-selected, deselect to keep." \
          --bind "start:select-all"
  )}")

  [[ ${#selected[@]} -eq 0 || -z "${selected[1]}" ]] && return

  for item in "${selected[@]}"; do
    wt_name="${item#● }"
    wt_name="${wt_name#  }"
    echo "Removing $wt_name..."
    git -C "$repo_dir" worktree remove "${wt_base}/${wt_name}" --force
  done
}

# Zellij
alias z="zellij"
# Linear
alias ln="linear-tui"
