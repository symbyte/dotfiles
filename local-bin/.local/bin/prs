#!/bin/bash
# prs - Open a PR review worktree in the all-prs Zellij session
#
# This script:
# 1. Lists PRs where you're requested as reviewer that have worktrees in ~/projects/wt
# 2. Excludes PRs currently open in nvim (via swap file detection)
# 3. Shows CI status, draft status, and age
# 4. Adds a new tab at the beginning of the 'all-prs' Zellij session with the 'review' layout

set -e

WT_DIR="$HOME/projects/wt"
SWAP_DIR="$HOME/.local/state/nvim/swap"

# Get PRs currently open in nvim (to exclude from list)
get_open_prs() {
    ls "$SWAP_DIR" 2>/dev/null | grep -oE 'pull%[0-9]+' | cut -d'%' -f2 | sort -u
}

# Get CI status for a PR
get_ci_status() {
    local pr_num="$1"
    local wt_path="$WT_DIR/pr-$pr_num"
    cd "$wt_path" 2>/dev/null && gh pr view --json statusCheckRollup --jq '
        .statusCheckRollup |
        if length == 0 then "pending"
        elif all(.state == "SUCCESS" or .state == "NEUTRAL" or .state == "SKIPPED") then "pass"
        elif any(.state == "FAILURE" or .state == "ERROR") then "fail"
        else "pending" end' 2>/dev/null || echo "pending"
}

# Get PRs needing review that have worktrees
get_review_prs() {
    local open_prs=$(get_open_prs)

    gh search prs --review-requested @me --state open \
        --json number,title,author,isDraft,createdAt --limit 50 2>/dev/null \
    | jq -r '.[] |
        (if .isDraft then "draft" else "open" end) as $state |
        (((now - (.createdAt | fromdateiso8601)) / 86400) | floor) as $days |
        (if $days == 0 then "today" elif $days == 1 then "1d" else "\($days)d" end) as $age |
        "\(.number)\t\($state)\t\($age)\t\(.title)\t\(.author.login)"' \
    | while IFS=$'\t' read -r num state age title author; do
        # Only include PRs with worktrees, not currently open in nvim
        if [[ -d "$WT_DIR/pr-$num" ]] && ! echo "$open_prs" | grep -qx "$num"; then
            local status=$(get_ci_status "$num")
            echo -e "$num\t#$num - $title [$author] ($state, $status, $age)"
        fi
    done
}

main() {
    # Clean stale octo swap files so closed PRs don't get excluded from the list
    find "$SWAP_DIR" -name '*octo*' -type f -delete 2>/dev/null

    local prs=$(get_review_prs)

    if [[ -z "$prs" ]]; then
        echo "No PR worktrees needing review" >&2
        exit 0
    fi

    local selected=$(echo "$prs" | fzf \
        --delimiter=$'\t' \
        --with-nth=2 \
        --preview-window=hidden \
        --header='PRs needing review (with worktrees)' \
        --prompt='PR: ')

    [[ -z "$selected" ]] && exit 0

    local pr_num=$(echo "$selected" | cut -f1)
    local wt_path="$WT_DIR/pr-$pr_num"

    if [[ ! -d "$wt_path" ]]; then
        echo "Worktree not found: $wt_path" >&2
        exit 1
    fi

    # Check if session already exists (strip ANSI codes from output)
    session_exists() {
        zellij list-sessions 2>/dev/null | sed 's/\x1b\[[0-9;]*m//g' | grep -q "^${1} "
    }

    local session_name="all-prs"

    if [[ -n "$ZELLIJ" ]]; then
        # Inside Zellij (presumably the all-prs session) - add a new tab at the beginning
        zellij action new-tab --layout review --name "pr-$pr_num" --cwd "$wt_path"
        # Move the new tab to the beginning
        local tab_count
        tab_count=$(zellij action query-tab-names 2>/dev/null | wc -l)
        for ((i = 1; i < tab_count; i++)); do
            zellij action move-tab left
        done
    elif session_exists "$session_name"; then
        # Outside Zellij, session exists - add tab via layout flag and attach
        cd "$wt_path"
        zellij attach "$session_name" -l review
    else
        # Outside Zellij, no session - create it with review layout
        cd "$wt_path"
        zellij -n review -s "$session_name"
    fi
}

main "$@"
